import Head from "next/head";
import { ChangeEvent, FormEvent, useState } from "react";

import {
  // Components
  NavBar,
  FormInputText,
  PieChartStatuses,
  PieChartFormats,
  PieChartCountries,
  BarChartScores,
  LineChartReleaseYears,
  Statistic,
  // Interfaces
  statusesItem,
  formatsItem,
  countriesItem,
  releaseYearsItem,
  scoresItem,
} from "@/components";

import { userQuery } from "@/utils";

import styles from "@/styles/User.module.css";

export default function User() {
  const [formInputTextValue, setFormInputTextValue] = useState<string>("");

  const [errorMessage, setErrorMessage] = useState<string>("");

  const [userName, setUserName] = useState<string>("");
  const [avatarUrl, setAvatarUrl] = useState<string>("");

  const [animeCount, setAnimeCount] = useState<string>("");
  const [animeEpisodesWatched, setAnimeEpisodesWatched] = useState<string>("");
  const [animeDaysWatched, setAnimeDaysWatched] = useState<string>("");

  const [animeStatuses, setAnimeStatuses] = useState<statusesItem[]>([]);
  const [animeFormats, setAnimeFormats] = useState<formatsItem[]>([]);
  const [animeCountries, setAnimeCountries] = useState<countriesItem[]>([]);
  const [animeScores, setAnimeScores] = useState<scoresItem[]>([]);
  const [animeReleaseYears, setAnimeReleaseYears] = useState<
    releaseYearsItem[]
  >([]);

  const fetchUser = async (name: string) => {
    const userName = formInputTextValue;

    setFormInputTextValue("");

    setErrorMessage("");

    setUserName("");
    setAvatarUrl("");

    setAnimeCount("");
    setAnimeEpisodesWatched("");
    setAnimeDaysWatched("");

    setAnimeStatuses([]);
    setAnimeFormats([]);
    setAnimeCountries([]);
    setAnimeScores([]);
    setAnimeReleaseYears([]);

    const url: string = "https://graphql.anilist.co";

    const variables: { name: string } = {
      name: name,
    };

    interface options {
      method: string;
      headers: {
        "Content-Type": string;
        Accept: string;
      };
      body: string;
    }

    const options: options = {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Accept: "application/json",
      },
      body: JSON.stringify({
        query: userQuery,
        variables: variables,
      }),
    };

    try {
      const response = await fetch(url, options);
      const data = await response.json();

      if (data.data.User !== null) {
        setAvatarUrl(data.data.User.avatar.large);
        setUserName(data.data.User.name);

        setAnimeCount(data.data.User.statistics.anime.count);
        setAnimeEpisodesWatched(
          data.data.User.statistics.anime.episodesWatched
        );
        setAnimeDaysWatched(
          Math.round(
            parseFloat(data.data.User.statistics.anime.minutesWatched) / 60 / 24
          ).toString()
        );

        setAnimeStatuses(data.data.User.statistics.anime.statuses);
        setAnimeFormats(data.data.User.statistics.anime.formats);
        setAnimeCountries(data.data.User.statistics.anime.countries);
        setAnimeScores(data.data.User.statistics.anime.scores);
        setAnimeReleaseYears(data.data.User.statistics.anime.releaseYears);
        console.log(data);
      } else {
        setErrorMessage(`There is no user named "${userName}"`);
      }
    } catch (e) {
      console.log(e);
    }
  };

  const submitHandler = (event: FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    fetchUser(formInputTextValue);
  };

  const changeHandler = (event: ChangeEvent<HTMLInputElement>) => {
    setFormInputTextValue(event.target.value);
  };

  return (
    <>
      <Head>
        <title>Review Charter - User</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <NavBar />
      <main className={styles["user"]}>
        <div className={styles["user__controls"]}>
          <FormInputText
            placeHolder="Username..."
            inputValue={formInputTextValue}
            submitHandler={submitHandler}
            changeHandler={changeHandler}
          />
        </div>
        <p>{errorMessage}</p>
        <div className={styles["user__avatar-name-container"]}>
          {avatarUrl && (
            <img className={styles["user__avatar"]} src={avatarUrl} />
          )}
          <h1>{userName}</h1>
        </div>
        <div className={styles["user__statistics"]}>
          {animeCount && (
            <Statistic statistic={animeCount} text="Total Anime" />
          )}
          {animeEpisodesWatched && (
            <Statistic
              statistic={animeEpisodesWatched}
              text="Episodes Watched"
            />
          )}
          {animeDaysWatched && (
            <Statistic statistic={animeDaysWatched} text="Days Watched" />
          )}
        </div>
        <div className={styles["user__pie-charts"]}>
          {animeStatuses.length > 0 && (
            <PieChartStatuses statuses={animeStatuses} />
          )}
          {animeFormats.length > 0 && (
            <PieChartFormats formats={animeFormats} />
          )}
          {animeCountries.length > 0 && (
            <PieChartCountries countries={animeCountries} />
          )}
        </div>
        {animeScores.length > 0 && <BarChartScores scores={animeScores} />}
        {animeReleaseYears.length > 0 && (
          <LineChartReleaseYears releaseYears={animeReleaseYears} />
        )}
      </main>
    </>
  );
}
