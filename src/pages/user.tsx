import Head from "next/head";
import { ChangeEvent, FormEvent, useState } from "react";

import { NavBar, FormInputText, PieChart } from "@/components";
import { userQuery } from "@/utils";

import styles from "@/styles/User.module.css";

interface formatItem {
  format: string;
  count: number;
}

export default function User() {
  const [formInputTextValue, setFormInputTextValue] = useState<string>("");
  const [userName, setUserName] = useState<string>("");
  const [avatarUrl, setAvatarUrl] = useState<string>("");
  const [formatLabels, setFormatLabels] = useState<string[]>([]);
  const [formatCounts, setFormatCounts] = useState<number[]>([]);

  const fetchUser = async (name: string) => {
    const url: string = "https://graphql.anilist.co";

    const variables: { name: string } = {
      name: name,
    };

    interface options {
      method: string;
      headers: { "Content-Type": string; Accept: string };
      body: string;
    }

    const options: options = {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Accept: "application/json",
      },
      body: JSON.stringify({
        query: userQuery,
        variables: variables,
      }),
    };

    try {
      const response = await fetch(url, options);
      const data = await response.json();

      const formats = data.data.User.statistics.anime.formats;

      const formatLabels: string[] = [];
      const formatCounts: number[] = [];

      formats.forEach((formatItem: formatItem) => {
        formatLabels.push(formatItem.format);
        formatCounts.push(formatItem.count);
      });

      setFormatLabels(formatLabels);
      setFormatCounts(formatCounts);
      setUserName(data.data.User.name);
      setAvatarUrl(data.data.User.avatar.large);
    } catch (e) {
      console.log(e);
    }
  };

  const submitHandler = (event: FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    fetchUser(formInputTextValue);
  };

  const changeHandler = (event: ChangeEvent<HTMLInputElement>) => {
    setFormInputTextValue(event.target.value);
  };

  return (
    <>
      <Head>
        <title>Review Charter - User</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <NavBar />
      <main className={styles["user"]}>
        <FormInputText
          labelText="Enter username:"
          inputValue={formInputTextValue}
          submitHandler={submitHandler}
          changeHandler={changeHandler}
        />
        {avatarUrl.length > 0 && (
          <img className={styles["user__avatar"]} src={avatarUrl} />
        )}
        <h1>{userName}</h1>
        <PieChart
          label="Number of type"
          labelArray={formatLabels}
          dataArray={formatCounts}
        />
      </main>
    </>
  );
}
